<!DOCTYPE html>
<html lang="en" data-theme="cosy-dark">
<head>
  <meta charset="UTF-8" />
  <title>RADIANT ‚Äî Cosy Rounded Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-body: #050816;
      --bg-panel: rgba(15, 23, 42, 0.96);
      --bg-elevated: rgba(17, 24, 39, 0.98);
      --bg-sidebar: rgba(15, 23, 42, 0.98);
      --bg-input: rgba(17, 24, 39, 0.98);
      --border-soft: rgba(148, 163, 184, 0.35);
      --border-strong: rgba(96, 165, 250, 0.9);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --accent-soft-1: #60a5fa;
      --accent-soft-2: #a855f7;
      --accent-soft-3: #f97373;
      --danger: #f97373;
      --chip-bg: rgba(15, 23, 42, 0.9);
      --chip-border: rgba(148, 163, 184, 0.4);
      --scrollbar: #4b5563;
      --grad1: #60a5fa;
      --grad2: #a855f7;
      --grad3: #f97373;
      --radius-panel: 22px;
      --radius-bubble: 18px;
      --radius-hard: 14px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.85);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    [data-theme="cosy-dark"] {
      --bg-body: #050816;
      --bg-panel: rgba(15, 23, 42, 0.96);
      --bg-elevated: rgba(17, 24, 39, 0.98);
      --bg-sidebar: rgba(15, 23, 42, 0.98);
      --bg-input: rgba(17, 24, 39, 0.98);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --scrollbar: #4b5563;
    }

    [data-theme="dark"] {
      --bg-body: #020617;
      --bg-panel: #020617;
      --bg-elevated: #020617;
      --bg-sidebar: #020617;
      --bg-input: #020617;
      --text-main: #e5e7eb;
      --text-muted: #6b7280;
      --accent-soft-1: #3b82f6;
      --accent-soft-2: #6366f1;
      --accent-soft-3: #f97373;
      --scrollbar: #6b7280;
    }

    [data-theme="light"] {
      --bg-body: #f3f4f6;
      --bg-panel: #ffffff;
      --bg-elevated: #ffffff;
      --bg-sidebar: #f9fafb;
      --bg-input: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: rgba(148, 163, 184, 0.6);
      --border-strong: rgba(59, 130, 246, 0.9);
      --scrollbar: #9ca3af;
    }

    [data-theme="midnight"] {
      --bg-body: #020617;
      --bg-panel: #020617;
      --bg-elevated: #020617;
      --bg-sidebar: #020617;
      --bg-input: #020617;
      --accent-soft-1: #38bdf8;
      --accent-soft-2: #6366f1;
      --accent-soft-3: #f97373;
      --text-main: #e5e7eb;
      --text-muted: #6b7280;
      --scrollbar: #4b5563;
    }

    [data-theme="orange"] {
      --bg-body: #111827;
      --bg-panel: #111827;
      --bg-elevated: #111827;
      --bg-sidebar: #111827;
      --bg-input: #111827;
      --accent-soft-1: #fb923c;
      --accent-soft-2: #f97316;
      --accent-soft-3: #f97373;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --scrollbar: #f97316;
    }

    [data-theme="bloom"] {
      --bg-body: #0b1020;
      --bg-panel: #0b1020;
      --bg-elevated: #0b1020;
      --bg-sidebar: #0b1020;
      --bg-input: #0b1020;
      --accent-soft-1: #ec4899;
      --accent-soft-2: #a855f7;
      --accent-soft-3: #f97373;
      --text-main: #fdf2f8;
      --text-muted: #f9a8d4;
      --scrollbar: #ec4899;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background:
        radial-gradient(circle at top left, rgba(96, 165, 250, 0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(168, 85, 247, 0.18), transparent 55%),
        var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 10px;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 999px;
    }

    .app-shell {
      width: 100%;
      max-width: 1240px;
      height: 100%;
      max-height: 720px;
      border-radius: 28px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(circle at top, var(--bg-panel), var(--bg-body));
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 70px rgba(15, 23, 42, 0.95);
      position: relative;
      backdrop-filter: blur(24px);
    }

    .app-header {
      padding: 10px 18px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(
        135deg,
        var(--bg-sidebar),
        var(--bg-elevated)
      );
      position: relative;
      z-index: 2;
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-core {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at top, var(--grad1), var(--grad2));
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.9);
    }

    .logo-core::before {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #020617, #020617);
    }

    .logo-core span {
      position: relative;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.16em;
      color: #e5e7eb;
    }

    .app-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .app-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .app-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--bg-sidebar);
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
    }

    .user-avatar {
      position: relative;
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at top, var(--grad1), var(--grad2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      color: #020617;
      overflow: hidden;
    }

    .user-avatar-dot {
      position: absolute;
      bottom: -1px;
      right: -1px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid #020617;
      background: #4b5563;
    }

    .status-online { background: #22c55e !important; }
    .status-away { background: #facc15 !important; }
    .status-offline { background: #4b5563 !important; }

    .user-pill-text {
      display: flex;
      flex-direction: column;
    }

    .user-pill-name {
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .user-pill-status {
      font-size: 11px;
      color: var(--text-muted);
    }

    .admin-tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(96, 165, 250, 0.12);
      border: 1px solid rgba(96, 165, 250, 0.7);
      color: #bfdbfe;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .header-buttons {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: var(--bg-sidebar);
      color: var(--text-main);
      font-size: 11px;
      padding: 5px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.12s ease;
    }

    .header-btn:hover {
      border-color: var(--border-strong);
      background: var(--bg-elevated);
      transform: translateY(-1px);
    }

    .header-btn-muted {
      opacity: 0.6;
    }

    .logout-btn {
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: rgba(127, 29, 29, 0.9);
      color: #fee2e2;
      font-size: 11px;
      padding: 5px 12px;
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease;
    }

    .logout-btn:hover {
      transform: translateY(-1px);
      background: rgba(153, 27, 27, 0.95);
    }

    .app-main {
      flex: 1;
      display: flex;
      min-height: 0;
      position: relative;
      z-index: 1;
      padding: 10px 12px 14px;
      gap: 10px;
    }

    .sidebar {
      width: 250px;
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: var(--bg-sidebar);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .sidebar-section {
      padding: 10px 12px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
      background: var(--bg-sidebar);
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .channel-list {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .channel-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 9px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      position: relative;
      transition: background 0.12s ease, color 0.12s ease, transform 0.08s ease;
    }

    .channel-item:hover {
      background: var(--bg-elevated);
      color: var(--text-main);
      transform: translateY(-1px);
    }

    .channel-item.active {
      background: var(--bg-elevated);
      color: #f9fafb;
      border: 1px solid rgba(96, 165, 250, 0.8);
    }

    .channel-hash {
      color: rgba(156, 163, 175, 0.9);
    }

    .userlist-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      background: var(--bg-sidebar);
    }

    .userlist-header {
      padding: 8px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
    }

    .userlist {
      flex: 1;
      overflow-y: auto;
      padding: 6px 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .userlist-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 7px;
      border-radius: 999px;
      background: transparent;
      cursor: default;
      transition: background 0.12s ease, transform 0.08s ease;
    }

    .userlist-item:hover {
      background: var(--bg-elevated);
      transform: translateY(-1px);
    }

    .userlist-avatar-wrap {
      position: relative;
      width: 28px;
      height: 28px;
    }

    .userlist-avatar {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #020617;
      background: radial-gradient(circle at top, var(--grad1), var(--grad2));
    }

    .userlist-status-dot {
      position: absolute;
      bottom: -1px;
      right: -1px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid var(--bg-body);
      background: #4b5563;
    }

    .userlist-name {
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .userlist-status-text {
      font-size: 11px;
      color: var(--text-muted);
    }

    .main-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      min-height: 0;
      background: var(--bg-panel);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .channel-header {
      padding: 10px 16px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
      display: flex;
      flex-direction: column;
      gap: 3px;
      background: var(--bg-sidebar);
    }

    .channel-header-top {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .channel-name {
      font-size: 15px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .channel-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 16px 10px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      background: radial-gradient(circle at top, var(--bg-panel), var(--bg-body));
    }

    .message {
      display: flex;
      gap: 10px;
      font-size: 13px;
      padding: 2px 0;
    }

    .message-avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #020617;
      margin-top: 2px;
      background: radial-gradient(circle at top, var(--grad1), var(--grad2));
      flex-shrink: 0;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
    }

    .message-body {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-width: 100%;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .message-username {
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .message-timestamp {
      font-size: 11px;
      color: var(--text-muted);
    }

    .message-text {
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
      padding: 8px 11px;
      border-radius: var(--radius-bubble);
      background: var(--bg-elevated);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-main);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
      transition: border-color 0.12s ease, background 0.12s ease, transform 0.08s ease;
    }

    .message-text a {
      color: #93c5fd;
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 2px;
    }

    .message-text:hover {
      border-color: rgba(96, 165, 250, 0.9);
      background: var(--bg-sidebar);
      transform: translateY(-1px);
    }

    .message-grouped {
      margin-left: 44px;
    }

    .reply-preview {
      display: flex;
      align-items: stretch;
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 3px;
      background: var(--bg-elevated);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .reply-preview-bar {
      width: 4px;
    }

    .reply-preview-text {
      padding: 4px 7px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .reply-btn,
    .admin-delete-btn {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: transparent;
      color: var(--text-muted);
      font-size: 11px;
      padding: 2px 7px;
      cursor: pointer;
      transition: border-color 0.12s ease, color 0.12s ease, transform 0.08s ease, background 0.12s ease;
    }

    .reply-btn:hover {
      border-color: var(--border-strong);
      color: #bfdbfe;
      transform: translateY(-1px);
      background: var(--bg-sidebar);
    }

    .admin-delete-btn {
      margin-left: 4px;
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .admin-delete-btn:hover {
      transform: translateY(-1px);
      background: rgba(69, 10, 10, 0.9);
    }

    .mention-highlight .message-text {
      background: rgba(30, 64, 175, 0.35);
      border-color: rgba(96, 165, 250, 0.95);
    }

    .input-area {
      border-top: 1px solid rgba(31, 41, 55, 0.8);
      padding: 8px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      background: var(--bg-sidebar);
      position: relative;
    }

    .reply-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 9px;
      border-radius: 16px;
      background: var(--bg-elevated);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 12px;
    }

    .reply-bar-gradient {
      width: 4px;
      align-self: stretch;
      border-radius: 999px;
    }

    .reply-bar-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .reply-bar-title {
      font-weight: 600;
      font-size: 12px;
    }

    .reply-bar-snippet {
      font-size: 11px;
      color: var(--text-muted);
    }

    .reply-bar-cancel {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: transparent;
      color: var(--text-muted);
      font-size: 11px;
      padding: 3px 7px;
      cursor: pointer;
      transition: border-color 0.12s ease, color 0.12s ease, background 0.12s ease, transform 0.08s ease;
    }

    .reply-bar-cancel:hover {
      border-color: var(--border-strong);
      color: #bfdbfe;
      background: var(--bg-elevated);
      transform: translateY(-1px);
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      position: relative;
    }

    /* NEW: image upload button (Discord-style, left of textarea) */
    .input-left-tools {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-right: 6px;
    }

    .image-upload-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 16px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.9);
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.08s ease, color 0.12s ease;
    }

    .image-upload-btn:hover {
      background: var(--bg-sidebar);
      border-color: var(--border-strong);
      color: #bfdbfe;
      transform: translateY(-1px);
    }

    .input-wrapper {
      flex: 1;
      background: var(--bg-input);
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 6px 10px;
      display: flex;
      align-items: center;
      position: relative;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
    }

    .input-wrapper textarea {
      flex: 1;
      border: none;
      outline: none;
      resize: none;
      background: transparent;
      color: var(--text-main);
      font-size: 13px;
      max-height: 80px;
    }

    .input-wrapper textarea::placeholder {
      color: var(--text-muted);
    }

    /* NEW: image preview strip under input */
    .image-preview-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      padding: 4px 2px 0;
    }

    .image-preview-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--bg-elevated);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 11px;
      color: var(--text-muted);
    }

    .image-preview-thumb {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      background: #020617;
      object-fit: cover;
      flex-shrink: 0;
    }

    .image-preview-remove {
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 13px;
      padding: 0;
    }

    .send-btn {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent-soft-1), var(--accent-soft-2));
      color: #020617;
      font-size: 13px;
      padding: 8px 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      transition: transform 0.12s ease, filter 0.12s ease, opacity 0.12s ease;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
    }

    .send-btn:hover:not(.disabled) {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .send-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      filter: grayscale(1);
      box-shadow: none;
    }

    .char-cap-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
      padding: 0 4px;
    }

    .char-cap-value {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--bg-elevated);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    #timeout-row {
      color: var(--danger);
      font-weight: 500;
    }

    .hidden {
      display: none !important;
    }

    .auth-view {
      flex: 1;
      display: flex;
      align-items: stretch;
      padding: 10px 12px 14px;
      gap: 10px;
    }

    .auth-left {
      flex: 1;
      padding: 32px 28px;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 12px;
      background: radial-gradient(circle at top left, rgba(96, 165, 250, 0.18), transparent 55%), var(--bg-panel);
      box-shadow: var(--shadow-soft);
    }

    .auth-title {
      font-size: 24px;
      font-weight: 700;
    }

    .auth-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 360px;
    }

    .auth-right {
      width: 360px;
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: var(--bg-panel);
      box-shadow: var(--shadow-soft);
    }

    .auth-toggle {
      display: flex;
      border-radius: 999px;
      padding: 3px;
      background: var(--bg-sidebar);
      border: 1px solid rgba(55, 65, 81, 0.9);
      gap: 3px;
    }

    .auth-toggle button {
      flex: 1;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      padding: 7px 0;
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease, transform 0.08s ease;
    }

    .auth-toggle button.active {
      background: linear-gradient(135deg, var(--accent-soft-1), var(--accent-soft-2));
      color: #020617;
      font-weight: 600;
      transform: translateY(-1px);
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .auth-form label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .auth-form input {
      width: 100%;
      padding: 8px 9px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: var(--bg-sidebar);
      color: var(--text-main);
      font-size: 13px;
    }

    .auth-form input:focus {
      outline: none;
      border-color: var(--border-strong);
    }

    .auth-submit {
      margin-top: 6px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent-soft-1), var(--accent-soft-2));
      color: #020617;
      font-size: 13px;
      padding: 8px 0;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
      transition: transform 0.12s ease, filter 0.12s ease;
    }

    .auth-submit:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .auth-error {
      font-size: 11px;
      color: #fecaca;
      min-height: 14px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-panel {
      background: var(--bg-panel);
      padding: 20px;
      border-radius: 20px;
      width: 340px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: var(--text-main);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.95);
    }

    .modal-panel-wide {
      width: 520px;
      max-height: 80vh;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    .modal-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: transparent;
      color: var(--text-main);
      cursor: pointer;
      font-size: 12px;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.08s ease;
    }

    .modal-btn:hover {
      background: var(--bg-elevated);
      border-color: var(--border-strong);
      transform: translateY(-1px);
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, var(--accent-soft-1), var(--accent-soft-2));
      border: none;
      color: #020617;
      font-weight: 600;
    }

    .modal-input {
      padding: 8px 9px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: var(--bg-sidebar);
      color: var(--text-main);
      font-size: 13px;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--border-strong);
    }

    .modal-label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .admin-users-container {
      margin-top: 4px;
      border-radius: 16px;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      padding: 8px;
      max-height: 60vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mention-dropdown {
      position: absolute;
      bottom: 100%;
      left: 10px;
      margin-bottom: 8px;
      min-width: 220px;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 16px;
      background: var(--bg-panel);
      border: 1px solid rgba(96, 165, 250, 0.8);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.95);
      z-index: 20;
      padding: 4px;
      backdrop-filter: blur(18px);
    }

    .mention-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 7px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-main);
      transition: background 0.12s ease, transform 0.08s ease;
    }

    .mention-item:hover,
    .mention-item.active {
      background: var(--bg-elevated);
      transform: translateY(-1px);
    }

    .mention-avatar {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #020617;
      background: radial-gradient(circle at top, var(--grad1), var(--grad2));
    }

    .mention-meta {
      display: flex;
      flex-direction: column;
    }

    .mention-name {
      font-size: 12px;
    }

    .mention-email {
      font-size: 10px;
      color: var(--text-muted);
    }

    @media (max-width: 900px) {
      body {
        padding: 0;
      }
      .app-shell {
        max-height: none;
        height: 100vh;
        border-radius: 0;
      }
      .app-main,
      .auth-view {
        padding: 8px;
      }
      .sidebar {
        display: none;
      }
      .main-column,
      .auth-left,
      .auth-right {
        border-radius: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-header-left">
        <div class="logo-core">
          <span>R</span>
        </div>
        <div class="app-title-block">
          <div class="app-title">RADIANT</div>
          <div class="app-subtitle">Cosy, rounded, Discord‚Äëstyle chat with channels & presence</div>
        </div>
      </div>
      <div class="app-header-right">
        <div class="user-pill">
          <div class="user-avatar">
            <span id="user-avatar-initials">R</span>
            <div id="user-avatar-dot" class="user-avatar-dot status-offline"></div>
          </div>
          <div class="user-pill-text">
            <div class="user-pill-name">
              <span id="user-email">User</span>
            </div>
            <div class="user-pill-status">
              <span id="user-status">Offline</span>
            </div>
          </div>
        </div>
        <div class="header-buttons">
          <button id="sound-toggle-btn" class="header-btn">
            <span id="sound-toggle-label">Sound on</span>
          </button>
          <button id="edit-profile-btn" class="header-btn">Profile</button>
          <button id="appearance-btn" class="header-btn">Appearance</button>
          <button id="admin-btn" class="header-btn hidden">Admin</button>
          <button id="logout-btn" class="logout-btn">Logout</button>
        </div>
      </div>
    </header>

    <!-- AUTH VIEW -->
    <div id="auth-view" class="auth-view">
      <div class="auth-left">
        <div class="auth-title">Welcome to RADIANT</div>
        <div class="auth-subtitle">
          A softer, rounded Discord‚Äëstyle chat with multiple channels, presence, mentions, and admin tools.
        </div>
      </div>
      <div class="auth-right">
        <div class="auth-toggle">
          <button id="toggle-login" class="active">Log in</button>
          <button id="toggle-signup">Sign up</button>
        </div>

        <form id="login-form" class="auth-form">
          <div>
            <label>Email</label>
            <input id="login-email" type="email" autocomplete="email" />
          </div>
          <div>
            <label>Password</label>
            <input id="login-password" type="password" autocomplete="current-password" />
          </div>
          <div class="auth-error" id="login-error"></div>
          <button type="submit" class="auth-submit">Log in</button>
        </form>

        <form id="signup-form" class="auth-form hidden">
          <div>
            <label>Email</label>
            <input id="signup-email" type="email" autocomplete="email" />
          </div>
          <div>
            <label>Password</label>
            <input id="signup-password" type="password" autocomplete="new-password" />
          </div>
          <div>
            <label>Username</label>
            <input id="signup-username" type="text" />
          </div>
          <div>
            <label>Custom status (optional)</label>
            <input id="signup-status" type="text" />
          </div>
          <div class="auth-error" id="signup-error"></div>
          <button type="submit" class="auth-submit">Create account</button>
        </form>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="app-view" class="app-main hidden">
      <aside class="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Channels</div>
          <div class="channel-list">
            <div class="channel-item active" data-channel-id="uni-general">
              <span class="channel-hash">#</span>
              <span>universal</span>
            </div>
            <div class="channel-item" data-channel-id="image-links">
              <span class="channel-hash">#</span>
              <span>image-links</span>
            </div>
          </div>
        </div>
        <div class="userlist-column">
          <div class="userlist-header">Users</div>
          <div id="user-list" class="userlist"></div>
        </div>
      </aside>

      <main class="main-column">
        <div class="channel-header">
          <div class="channel-header-top">
            <div class="channel-name">
              <span class="channel-hash">#</span>
              <span id="channel-name">universal</span>
            </div>
          </div>
          <div id="channel-subtitle" class="channel-subtitle">
            Global chat for everyone in RADIANT
          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="input-area">
          <div id="reply-bar" class="reply-bar hidden">
            <div id="reply-bar-gradient" class="reply-bar-gradient"></div>
            <div class="reply-bar-main">
              <div id="reply-bar-title" class="reply-bar-title"></div>
              <div id="reply-bar-snippet" class="reply-bar-snippet"></div>
            </div>
            <button id="reply-bar-cancel" class="reply-bar-cancel">Cancel</button>
          </div>

          <div class="input-row">
            <!-- NEW: image upload button + hidden file input -->
            <div class="input-left-tools">
              <button id="image-upload-btn" type="button" class="image-upload-btn" title="Upload image">
                +
              </button>
              <input
                id="image-file-input"
                type="file"
                accept=".png,.jpg,.jpeg,.gif,.webp,.bmp,.tif,.tiff,.jfif,.pjp,.apng,.xbm"
                class="hidden"
              />
            </div>

            <div class="input-wrapper">
              <textarea id="message-input" rows="1" placeholder="Message #universal"></textarea>
              <div id="mention-dropdown" class="mention-dropdown hidden"></div>
            </div>
            <button id="send-btn" class="send-btn">
              <span>Send</span>
            </button>
          </div>

          <!-- NEW: image preview strip (chips for selected images) -->
          <div id="image-preview-strip" class="image-preview-strip hidden"></div>

          <div class="char-cap-row">
            <span id="char-cap" class="char-cap-value">0 / 1000</span>
          </div>

          <div id="timeout-row" class="char-cap-row hidden" style="justify-content:flex-start; gap:6px;">
            <span style="font-size:12px;">‚è±Ô∏è</span>
            <span id="timeout-text" style="font-size:12px;color:#f97373;"></span>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- EDIT PROFILE MODAL -->
  <div id="edit-profile-modal" class="modal-backdrop hidden">
    <div class="modal-panel">
      <h3 style="margin: 0; font-size: 18px;">Edit Profile</h3>

      <label class="modal-label">Username</label>
      <input id="edit-username" type="text" class="modal-input">

      <label class="modal-label">Custom status</label>
      <input id="edit-status" type="text" class="modal-input">

      <label class="modal-label" style="margin-top: 6px;">Gradient Color 1</label>
      <input id="edit-grad1" type="color" style="width: 60px; height: 32px; padding: 0; border-radius: 999px; border: 1px solid var(--border-soft); background: transparent;">

      <label class="modal-label">Gradient Color 2</label>
      <input id="edit-grad2" type="color" style="width: 60px; height: 32px; padding: 0; border-radius: 999px; border: 1px solid var(--border-soft); background: transparent;">

      <label class="modal-label">Gradient Color 3</label>
      <input id="edit-grad3" type="color" style="width: 60px; height: 32px; padding: 0; border-radius: 999px; border: 1px solid var(--border-soft); background: transparent;">

      <div class="modal-footer">
        <button id="cancel-edit" class="modal-btn">Cancel</button>
        <button id="save-edit" class="modal-btn modal-btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- APPEARANCE MODAL -->
  <div id="appearance-modal" class="modal-backdrop hidden">
    <div class="modal-panel">
      <h3 style="margin: 0; font-size: 18px;">Appearance</h3>

      <label class="modal-label">Theme</label>
      <select id="theme-select" class="modal-input" style="padding-right: 24px;">
        <option value="cosy-dark">Cosy Dark</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="midnight">Midnight</option>
        <option value="orange">Orange</option>
        <option value="bloom">Bloom</option>
      </select>

      <div class="modal-footer">
        <button id="close-appearance" class="modal-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- ADMIN MODAL -->
  <div id="admin-modal" class="modal-backdrop hidden">
    <div class="modal-panel modal-panel-wide">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin: 0; font-size: 18px;">Admin Panel</h3>
        <button id="admin-close" style="
          border:none;
          background:transparent;
          color:var(--text-muted);
          cursor:pointer;
          font-size:18px;
        ">√ó</button>
      </div>

      <div style="font-size:12px; color:var(--text-muted);">
        Manage users in the tablist: timeouts, presence, and hide/show.
      </div>

      <div id="admin-users-container" class="admin-users-container"></div>
    </div>
  </div>

  <!-- CHANGELOG MODAL -->
  <div id="changelog-modal" class="modal-backdrop hidden">
    <div class="modal-panel modal-panel-wide">
      <h3 style="margin:0;font-size:20px;">What‚Äôs New</h3>

      <div style="font-size:13px;color:var(--text-muted);margin-bottom:10px;">
        Recent improvements to your RADIANT experience
      </div>

      <div style="display:flex;flex-direction:column;gap:12px;max-height:60vh;overflow-y:auto;padding-right:4px;">

        <div style="padding:10px;border-radius:14px;background:var(--bg-elevated);border:1px solid var(--border-soft);">
          <div style="font-weight:600;font-size:14px;margin-bottom:4px;">‚ú® New UI</div>
          <div style="font-size:13px;color:var(--text-muted);">
            A fully revamped cosy, rounded interface with softer panels, improved readability, and a more Discord‚Äëlike layout.
          </div>
        </div>

        <div style="padding:10px;border-radius:14px;background:var(--bg-elevated);border:1px solid var(--border-soft);">
          <div style="font-weight:600;font-size:14px;margin-bottom:4px;">üîî Mention Pings & Sounds</div>
          <div style="font-size:13px;color:var(--text-muted);">
            Mentions now glow, highlight, and trigger a ping sound ‚Äî with a toggle to mute them anytime.
          </div>
        </div>

        <div style="padding:10px;border-radius:14px;background:var(--bg-elevated);border:1px solid var(--border-soft);">
          <div style="font-weight:600;font-size:14px;margin-bottom:4px;">üìÅ Another Channel</div>
          <div style="font-size:13px;color:var(--text-muted);">
            A new <strong>#image-links</strong> channel has been added for sharing image URLs and references.
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button id="changelog-close-btn" class="modal-btn modal-btn-primary" disabled>
          Close (5)
        </button>
      </div>
    </div>
  </div>

  <!-- Mention / notification sound -->
  <audio id="mention-sound">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
  </audio>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      doc,
      setDoc,
      getDoc,
      serverTimestamp,
      deleteDoc,
      runTransaction,
      deleteField
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD4rfKO1U_LAxKyrIrQuRXeI1saokMInhA",
      authDomain: "orangefox-ce8b1.firebaseapp.com",
      projectId: "orangefox-ce8b1",
      storageBucket: "orangefox-ce8b1.firebasestorage.app",
      messagingSenderId: "859089557525",
      appId: "1:859089557525:web:2852c1975458b867cc561c",
      measurementId: "G-LLB6S2MVB5"
    };

    const ADMIN_EMAIL = "adminsecret@orangefox.com";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authView = document.getElementById("auth-view");
    const appView = document.getElementById("app-view");

    const toggleLogin = document.getElementById("toggle-login");
    const toggleSignup = document.getElementById("toggle-signup");
    const loginForm = document.getElementById("login-form");
    const signupForm = document.getElementById("signup-form");
    const loginError = document.getElementById("login-error");
    const signupError = document.getElementById("signup-error");

    const logoutBtn = document.getElementById("logout-btn");
    const userEmailSpan = document.getElementById("user-email");
    const userStatusSpan = document.getElementById("user-status");
    const userAvatarInitials = document.getElementById("user-avatar-initials");
    const userAvatarDot = document.getElementById("user-avatar-dot");

    const messagesEl = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const charCapEl = document.getElementById("char-cap");

    const editProfileBtn = document.getElementById("edit-profile-btn");
    const editProfileModal = document.getElementById("edit-profile-modal");
    const editUsernameInput = document.getElementById("edit-username");
    const editStatusInput = document.getElementById("edit-status");
    const editGrad1Input = document.getElementById("edit-grad1");
    const editGrad2Input = document.getElementById("edit-grad2");
    const editGrad3Input = document.getElementById("edit-grad3");
    const cancelEditBtn = document.getElementById("cancel-edit");
    const saveEditBtn = document.getElementById("save-edit");

    const userListEl = document.getElementById("user-list");
    const channelNameEl = document.getElementById("channel-name");
    const channelSubtitleEl = document.getElementById("channel-subtitle");

    const appearanceBtn = document.getElementById("appearance-btn");
    const appearanceModal = document.getElementById("appearance-modal");
    const closeAppearance = document.getElementById("close-appearance");
    const themeSelect = document.getElementById("theme-select");

    const replyBar = document.getElementById("reply-bar");
    const replyBarGradient = document.getElementById("reply-bar-gradient");
    const replyBarTitle = document.getElementById("reply-bar-title");
    const replyBarSnippet = document.getElementById("reply-bar-snippet");
    const replyBarCancel = document.getElementById("reply-bar-cancel");

    const adminBtn = document.getElementById("admin-btn");
    const adminModal = document.getElementById("admin-modal");
    const adminClose = document.getElementById("admin-close");
    const adminUsersContainer = document.getElementById("admin-users-container");

    const timeoutRow = document.getElementById("timeout-row");
    const timeoutText = document.getElementById("timeout-text");

    const mentionDropdown = document.getElementById("mention-dropdown");
    const mentionSound = document.getElementById("mention-sound");

    const soundToggleBtn = document.getElementById("sound-toggle-btn");
    const soundToggleLabel = document.getElementById("sound-toggle-label");

    const changelogModal = document.getElementById("changelog-modal");
    const changelogCloseBtn = document.getElementById("changelog-close-btn");

    // --- IMAGE UPLOAD HOOKS (chunk 2 addition) ---
    const imageUploadBtn = document.getElementById("image-upload-btn");
    const imageFileInput = document.getElementById("image-file-input");
    const imageAttachPill = document.getElementById("image-attach-pill");
    const imageAttachClear = document.getElementById("image-attach-clear");

    // pendingImage: { dataUrl, name, type, size }
    let pendingImage = null;

    function updateImageAttachUI() {
      if (!imageAttachPill) return;
      if (!pendingImage) {
        imageAttachPill.classList.add("hidden");
        return;
      }
      const label = imageAttachPill.querySelector(".image-attach-label");
      if (label) {
        const prettySize = pendingImage.size
          ? `${Math.round(pendingImage.size / 1024)} KB`
          : "";
        label.textContent = `${pendingImage.name || "image"}${prettySize ? ` ‚Ä¢ ${prettySize}` : ""}`;
      }
      imageAttachPill.classList.remove("hidden");
    }

    if (imageUploadBtn && imageFileInput) {
      imageUploadBtn.addEventListener("click", () => {
        imageFileInput.click();
      });

      imageFileInput.addEventListener("change", () => {
        const file = imageFileInput.files && imageFileInput.files[0];
        if (!file) return;

        // Simple guardrail: limit to ~1.5MB to keep Base64 manageable
        const maxBytes = 12 * 1024 * 1024; // 12MB 
        if (file.size > maxBytes) {
          alert("Image is too large. Please choose one under ~1.5MB.");
          imageFileInput.value = "";
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          if (typeof result === "string") {
            pendingImage = {
              dataUrl: result, // full data URL (Base64)
              name: file.name,
              type: file.type,
              size: file.size
            };
            updateImageAttachUI();
          }
        };
        reader.readAsDataURL(file);
      });
    }

    if (imageAttachClear) {
      imageAttachClear.addEventListener("click", () => {
        pendingImage = null;
        if (imageFileInput) imageFileInput.value = "";
        updateImageAttachUI();
      });
    }

    let currentUserProfile = null;
    let currentChannelId = "uni-general";
    let isAdmin = false;

    let heartbeatInterval = null;
    let visibilityListenerAttached = false;
    let visibilityHandler = null;
    let lastPresenceApplied = null;

    let messagesUnsub = null;
    let usersUnsub = null;

    const usersCache = new Map();

    let activeReply = null;
    let lastMessageTime = 0;
    let timeoutInterval = null;

    let lastSeenMessageTime = 0;
    let suppressMentionSound = true;

    const mentionState = {
      open: false,
      filter: "",
      items: [],
      activeIndex: 0,
      triggerIndex: -1
    };

    let mentionMuted = localStorage.getItem("mentionMuted") === "1";

    function updateSoundToggleUI() {
      if (mentionMuted) {
        soundToggleLabel.textContent = "Sound off";
        soundToggleBtn.classList.add("header-btn-muted");
      } else {
        soundToggleLabel.textContent = "Sound on";
        soundToggleBtn.classList.remove("header-btn-muted");
      }
    }

    soundToggleBtn.addEventListener("click", () => {
      mentionMuted = !mentionMuted;
      localStorage.setItem("mentionMuted", mentionMuted ? "1" : "0");
      updateSoundToggleUI();
    });

    updateSoundToggleUI();

    function setActiveReply(info) {
      if (!info) {
        activeReply = null;
        replyBar.classList.add("hidden");
        return;
      }
      activeReply = info;
      replyBar.classList.remove("hidden");
      replyBarTitle.textContent = `Replying to ${info.username}`;
      replyBarSnippet.textContent = info.text || "";
      replyBarGradient.style.background = `linear-gradient(180deg, ${info.grad1}, ${info.grad2}, ${info.grad3})`;
    }

    replyBarCancel.addEventListener("click", () => {
      setActiveReply(null);
    });

    function initialsFromName(nameOrEmail) {
      if (!nameOrEmail) return "R";
      const base = nameOrEmail.split("@")[0];
      const parts = base.split(/[.\s_-]+/).filter(Boolean);
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
    }

    function formatTimestampFromMsOrTs(createdAtMs, createdAt) {
      let d;
      if (typeof createdAtMs === "number") {
        d = new Date(createdAtMs);
      } else if (createdAt && createdAt.toDate) {
        d = createdAt.toDate();
      } else {
        return "";
      }
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function scrollMessagesToBottom() {
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    function presenceLabel(p) {
      if (p === "online") return "Online";
      if (p === "away") return "Away";
      return "Offline";
    }

    function applyDotClass(el, presence) {
      el.classList.remove("status-online", "status-away", "status-offline");
      if (presence === "online") el.classList.add("status-online");
      else if (presence === "away") el.classList.add("status-away");
      else el.classList.add("status-offline");
    }

    function applyOwnPresence(presence) {
      if (presence === lastPresenceApplied) return;
      lastPresenceApplied = presence;
      userStatusSpan.textContent = presenceLabel(presence);
      applyDotClass(userAvatarDot, presence);
    }

    function applyGradientVars(grad1, grad2, grad3) {
      document.documentElement.style.setProperty("--grad1", grad1 || "#60a5fa");
      document.documentElement.style.setProperty("--grad2", grad2 || "#a855f7");
      document.documentElement.style.setProperty("--grad3", grad3 || "#f97373");
    }

    function computeEffectivePresence(u) {
      if (!u) return "offline";

      const overridden = u.presenceOverride === true;
      if (overridden) {
        return u.presence || "offline";
      }

      const last = typeof u.lastActive === "number"
        ? u.lastActive
        : (u.lastActive && u.lastActive.toMillis ? u.lastActive.toMillis() : 0);

      if (!last) return "offline";

      const delta = Date.now() - last;

      if (delta < 10_000) return "online";
      if (delta < 60_000) return "away";
      return "offline";
    }

    function isTimedOut(profile) {
      if (!profile) return false;
      const until = profile.timeoutUntil;
      if (!until) return false;

      const ms = typeof until === "number"
        ? until
        : (until.toMillis ? until.toMillis() : 0);

      if (!ms) return false;
      return Date.now() < ms;
    }

    function updateTimeoutUI() {
      if (!currentUserProfile || !isTimedOut(currentUserProfile)) {
        timeoutRow.classList.add("hidden");
        sendBtn.classList.remove("disabled");
        sendBtn.disabled = false;
        if (timeoutInterval) clearInterval(timeoutInterval);
        return;
      }

      timeoutRow.classList.remove("hidden");
      sendBtn.classList.add("disabled");
      sendBtn.disabled = true;

      if (timeoutInterval) clearInterval(timeoutInterval);

      function tick() {
        const until = currentUserProfile.timeoutUntil;
        const ms = typeof until === "number" ? until : until.toMillis();
        const remaining = ms - Date.now();
        if (remaining <= 0) {
          timeoutRow.classList.add("hidden");
          sendBtn.classList.remove("disabled");
          sendBtn.disabled = false;
          clearInterval(timeoutInterval);
          return;
        }

        const sec = Math.floor(remaining / 1000);
        const m = Math.floor(sec / 60);
        const s = sec % 60;

        timeoutText.textContent = `You are timed out for ${m}:${s.toString().padStart(2, "0")}`;
      }

      tick();
      timeoutInterval = setInterval(tick, 1000);
    }

    toggleLogin.addEventListener("click", () => {
      toggleLogin.classList.add("active");
      toggleSignup.classList.remove("active");
      loginForm.classList.remove("hidden");
      signupForm.classList.add("hidden");
      loginError.textContent = "";
      signupError.textContent = "";
    });

    toggleSignup.addEventListener("click", () => {
      toggleSignup.classList.add("active");
      toggleLogin.classList.remove("active");
      signupForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
      loginError.textContent = "";
      signupError.textContent = "";
    });

    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      signupError.textContent = "";

      const email = document.getElementById("signup-email").value.trim();
      const password = document.getElementById("signup-password").value;
      const username = document.getElementById("signup-username").value.trim();
      const customStatus = (document.getElementById("signup-status").value.trim() || "");

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const user = cred.user;

        await setDoc(doc(db, "users", user.uid), {
          email,
          username,
          customStatus,
          presence: "online",
          lastActive: Date.now(),
          createdAt: Date.now(),
          grad1: "#60a5fa",
          grad2: "#a855f7",
          grad3: "#f97373",
          timeoutUntil: null,
          hidden: false,
          presenceOverride: false
        });
      } catch (err) {
        signupError.textContent = err.message;
      }
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";

      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        loginError.textContent = err.message;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    editProfileBtn.addEventListener("click", () => {
      if (!currentUserProfile) return;
      editUsernameInput.value = currentUserProfile.username || "";
      editStatusInput.value = currentUserProfile.customStatus || "";
      editGrad1Input.value = currentUserProfile.grad1 || "#60a5fa";
      editGrad2Input.value = currentUserProfile.grad2 || "#a855f7";
      editGrad3Input.value = currentUserProfile.grad3 || "#f97373";
      editProfileModal.classList.remove("hidden");
    });

    cancelEditBtn.addEventListener("click", () => {
      editProfileModal.classList.add("hidden");
    });

    saveEditBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;

      const newUsername = editUsernameInput.value.trim() || user.email;
      const newCustomStatus = editStatusInput.value.trim() || "";
      const newGrad1 = editGrad1Input.value || "#60a5fa";
      const newGrad2 = editGrad2Input.value || "#a855f7";
      const newGrad3 = editGrad3Input.value || "#f97373";

      try {
        await setDoc(doc(db, "users", user.uid), {
          username: newUsername,
          customStatus: newCustomStatus,
          grad1: newGrad1,
          grad2: newGrad2,
          grad3: newGrad3
        }, { merge: true });

        const updatedSnap = await getDoc(doc(db, "users", user.uid));
        const updatedProfile = updatedSnap.exists() ? updatedSnap.data() : null;

        currentUserProfile = {
          ...(currentUserProfile || {}),
          email: updatedProfile?.email || user.email,
          username: updatedProfile?.username || newUsername,
          customStatus: updatedProfile?.customStatus || newCustomStatus,
          presence: computeEffectivePresence(updatedProfile || currentUserProfile),
          grad1: updatedProfile?.grad1 || newGrad1,
          grad2: updatedProfile?.grad2 || newGrad2,
          grad3: updatedProfile?.grad3 || newGrad3,
          timeoutUntil: updatedProfile?.timeoutUntil || null,
          hidden: updatedProfile?.hidden ?? currentUserProfile?.hidden ?? false,
          presenceOverride: updatedProfile?.presenceOverride ?? false
        };

        renderSidebarUserName();
        userAvatarInitials.textContent = initialsFromName(currentUserProfile.username);
        applyGradientVars(currentUserProfile.grad1, currentUserProfile.grad2, currentUserProfile.grad3);
        applyOwnPresence(currentUserProfile.presence);
        updateTimeoutUI();

        editProfileModal.classList.add("hidden");
      } catch (err) {
        console.error("Error updating profile:", err);
      }
    });

    function createAdminTag() {
      const span = document.createElement("span");
      span.className = "admin-tag";
      span.textContent = "Admin";
      return span;
    }

    function renderSidebarUserName() {
      const nameContainer = userEmailSpan;
      nameContainer.innerHTML = "";
      const textNode = document.createTextNode(currentUserProfile.username || currentUserProfile.email || "User");
      nameContainer.appendChild(textNode);
      if (isAdmin) {
        nameContainer.appendChild(createAdminTag());
      }
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function linkify(text) {
      const urlRegex = /((https?:\/\/|www\.)[^\s<]+)/gi;
      return text.replace(urlRegex, (match) => {
        let url = match;
        if (!/^https?:\/\//i.test(url)) {
          url = "https://" + url;
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
      });
    }

    function renderMessage(msg, grouped, id) {
      const msgEl = document.createElement("div");
      msgEl.className = "message";
      if (grouped) msgEl.classList.add("message-grouped");

      const displayName = msg.username || msg.userEmail || "Unknown";

      const senderProfile = msg.sender ? usersCache.get(msg.sender) : null;
      const g1 = senderProfile?.grad1 || "#60a5fa";
      const g2 = senderProfile?.grad2 || "#a855f7";
      const g3 = senderProfile?.grad3 || "#f97373";

      const isMention = (() => {
        if (!currentUserProfile || !msg.text) return false;
        const uname = currentUserProfile.username || "";
        if (!uname) return false;
        const pattern = new RegExp(`@${uname.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")}(\\b|$)`, "i");
        return pattern.test(msg.text);
      })();

      const hasImage = !!msg.imageData;

      function buildImageElement() {
        if (!hasImage) return null;
        const wrap = document.createElement("div");
        wrap.className = "message-image-wrap";
        wrap.style.marginTop = msg.text ? "6px" : "0";
        const img = document.createElement("img");
        img.className = "message-image";
        img.src = msg.imageData;
        img.alt = msg.imageName || "image";
        img.style.maxWidth = "260px";
        img.style.maxHeight = "220px";
        img.style.borderRadius = "14px";
        img.style.display = "block";
        img.style.border = "1px solid rgba(15,23,42,0.9)";
        img.style.boxShadow = "0 14px 32px rgba(15,23,42,0.95)";
        wrap.appendChild(img);
        return wrap;
      }

      if (!grouped) {
        const avatarEl = document.createElement("div");
        avatarEl.className = "message-avatar";
        avatarEl.textContent = initialsFromName(displayName);
        avatarEl.style.background = `radial-gradient(circle at top, ${g1}, ${g2})`;

        const bodyEl = document.createElement("div");
        bodyEl.className = "message-body";

        if (msg.replyPreview) {
          const rp = msg.replyPreview;
          const rg1 = rp.grad1 || g1;
          const rg2 = rp.grad2 || g2;
          const rg3 = rp.grad3 || g3;

          const rpEl = document.createElement("div");
          rpEl.className = "reply-preview";

          const barEl = document.createElement("div");
          barEl.className = "reply-preview-bar";
          barEl.style.background = `linear-gradient(180deg, ${rg1}, ${rg2}, ${rg3})`;

          const textEl = document.createElement("div");
          textEl.className = "reply-preview-text";
          const uname = rp.username || "Unknown";
          const snippet = rp.text || "";
          textEl.innerHTML = `<strong>${escapeHtml(uname)}</strong> ‚Äî ${escapeHtml(snippet)}`;

          rpEl.appendChild(barEl);
          rpEl.appendChild(textEl);
          bodyEl.appendChild(rpEl);
        }

        const headerEl = document.createElement("div");
        headerEl.className = "message-header";

        const usernameEl = document.createElement("span");
        usernameEl.className = "message-username";

        const nameText = document.createElement("span");
        nameText.textContent = displayName;
        usernameEl.appendChild(nameText);

        if (msg.userEmail === ADMIN_EMAIL) {
          usernameEl.appendChild(createAdminTag());
        }

        const tsEl = document.createElement("span");
        tsEl.className = "message-timestamp";
        tsEl.textContent = formatTimestampFromMsOrTs(msg.createdAtMs, msg.createdAt);

        const replyBtn = document.createElement("button");
        replyBtn.className = "reply-btn";
        replyBtn.textContent = "‚Ü©";
        replyBtn.title = "Reply";

        replyBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const snippet = (msg.text || "").trim().slice(0, 80);
          const info = {
            messageId: id,
            username: displayName,
            text: snippet,
            grad1: g1,
            grad2: g2,
            grad3: g3
          };
          setActiveReply(info);
        });

        headerEl.appendChild(usernameEl);
        headerEl.appendChild(tsEl);
        headerEl.appendChild(replyBtn);

        if (isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.className = "admin-delete-btn";
          delBtn.textContent = "Delete";
          delBtn.title = "Delete message";
          delBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            try {
              await deleteDoc(doc(db, "channels", currentChannelId, "messages", id));
            } catch (err) {
              console.error("Error deleting message:", err);
            }
          });
          headerEl.appendChild(delBtn);
        }

        const textEl = document.createElement("div");
        textEl.className = "message-text";

        const safe = escapeHtml(msg.text || "");
        textEl.innerHTML = linkify(safe);

        if (isMention) {
          msgEl.classList.add("mention-highlight");
        }

        bodyEl.appendChild(headerEl);

        // If there is text or image, show bubble; if no text but image, keep bubble for image
        if (msg.text || hasImage) {
          bodyEl.appendChild(textEl);
          const imgEl = buildImageElement();
          if (imgEl) {
            textEl.appendChild(imgEl);
          }
        }

        msgEl.appendChild(avatarEl);
        msgEl.appendChild(bodyEl);
      } else {
        const bodyWrap = document.createElement("div");
        bodyWrap.style.display = "flex";
        bodyWrap.style.alignItems = "center";
        bodyWrap.style.width = "100%";
        bodyWrap.style.gap = "4px";

        const textContainer = document.createElement("div");
        textContainer.style.display = "flex";
        textContainer.style.flexDirection = "column";
        textContainer.style.flex = "1";

        if (msg.replyPreview) {
          const rp = msg.replyPreview;
          const rg1 = rp.grad1 || g1;
          const rg2 = rp.grad2 || g2;
          const rg3 = rp.grad3 || g3;

          const rpEl = document.createElement("div");
          rpEl.className = "reply-preview";

          const barEl = document.createElement("div");
          barEl.className = "reply-preview-bar";
          barEl.style.background = `linear-gradient(180deg, ${rg1}, ${rg2}, ${rg3})`;

          const textEl = document.createElement("div");
          textEl.className = "reply-preview-text";
          const uname = rp.username || "Unknown";
          const snippet = rp.text || "";
          textEl.innerHTML = `<strong>${escapeHtml(uname)}</strong> ‚Äî ${escapeHtml(snippet)}`;

          rpEl.appendChild(barEl);
          rpEl.appendChild(textEl);
          textContainer.appendChild(rpEl);
        }

        const textEl = document.createElement("div");
        textEl.className = "message-text";
        const safe = escapeHtml(msg.text || "");
        textEl.innerHTML = linkify(safe);

        if (isMention) {
          msgEl.classList.add("mention-highlight");
        }

        if (msg.text || hasImage) {
          textContainer.appendChild(textEl);
          const imgEl = buildImageElement();
          if (imgEl) {
            textEl.appendChild(imgEl);
          }
        }

        const controls = document.createElement("div");
        controls.style.display = "flex";
        controls.style.alignItems = "center";
        controls.style.gap = "4px";

        const replyBtn = document.createElement("button");
        replyBtn.className = "reply-btn";
        replyBtn.textContent = "‚Ü©";
        replyBtn.title = "Reply";

        replyBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const snippet = (msg.text || "").trim().slice(0, 80);
          const info = {
            messageId: id,
            username: displayName,
            text: snippet,
            grad1: g1,
            grad2: g2,
            grad3: g3
          };
          setActiveReply(info);
        });

        controls.appendChild(replyBtn);

        if (isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.className = "admin-delete-btn";
          delBtn.textContent = "Delete";
          delBtn.title = "Delete message";
          delBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            try {
              await deleteDoc(doc(db, "channels", currentChannelId, "messages", id));
            } catch (err) {
              console.error("Error deleting message:", err);
            }
          });
          controls.appendChild(delBtn);
        }

        bodyWrap.appendChild(textContainer);
        bodyWrap.appendChild(controls);
        msgEl.appendChild(bodyWrap);
      }

      messagesEl.appendChild(msgEl);
    }

    function subscribeToChannelMessages(channelId) {
      if (messagesUnsub) messagesUnsub();

      lastSeenMessageTime = 0;
      suppressMentionSound = true;

      const q = query(
        collection(db, "channels", channelId, "messages"),
        orderBy("createdAt", "asc")
      );

      messagesUnsub = onSnapshot(q, (snapshot) => {
        messagesEl.innerHTML = "";

        let lastUser = null;
        let lastTimestamp = 0;
        let maxTimeSeen = lastSeenMessageTime;

        snapshot.forEach((docSnap) => {
          const msg = docSnap.data();
          const id = docSnap.id;

          const displayName = msg.username || msg.userEmail || "Unknown";

          const thisTime = typeof msg.createdAtMs === "number"
            ? msg.createdAtMs
            : (msg.createdAt?.toMillis ? msg.createdAt.toMillis() : Date.now());

          const sameUser = displayName === lastUser;
          const withinWindow = Math.abs(thisTime - lastTimestamp) < 3 * 60 * 1000;

          let grouped = sameUser && withinWindow;
          if (msg.replyTo) grouped = false;

          renderMessage(msg, grouped, id);

          const isOwn = auth.currentUser && msg.sender === auth.currentUser.uid;
          const isMention = (() => {
            if (!currentUserProfile || !msg.text) return false;
            const uname = currentUserProfile.username || "";
            if (!uname) return false;
            const pattern = new RegExp(`@${uname.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")}(\\b|$)`, "i");
            return pattern.test(msg.text);
          })();

          if (!suppressMentionSound && !mentionMuted && !isOwn && isMention && thisTime > lastSeenMessageTime) {
            try {
              mentionSound.currentTime = 0;
              mentionSound.play().catch(() => {});
            } catch {}
          }

          if (thisTime > maxTimeSeen) {
            maxTimeSeen = thisTime;
          }

          lastUser = displayName;
          lastTimestamp = thisTime;
        });

        lastSeenMessageTime = maxTimeSeen;
        suppressMentionSound = false;

        scrollMessagesToBottom();
      });
    }

    async function sendChannelMessage() {
      const user = auth.currentUser;
      if (!user || !currentChannelId) return;

      if (isTimedOut(currentUserProfile)) {
        updateTimeoutUI();
        return;
      }

      const now = Date.now();
      if (now - lastMessageTime < 2000) {
        alert("Please wait 2 seconds before sending another message.");
        return;
      }

      const text = messageInput.value.trim();

      // Allow messages that are either text, image, or both
      if (!text && !pendingImage) return;

      if (text.length > 1000) {
        alert("Messages are limited to 1000 characters.");
        return;
      }

      const username = currentUserProfile?.username || user.email;
      const nowMs = Date.now();

      const payload = {
        text,
        userEmail: user.email,
        username,
        sender: user.uid,
        createdAt: serverTimestamp(),
        createdAtMs: nowMs
      };

      if (pendingImage) {
        payload.imageData = pendingImage.dataUrl;
        payload.imageName = pendingImage.name || null;
        payload.imageType = pendingImage.type || null;
        payload.imageSize = pendingImage.size || null;
      }

      if (activeReply) {
        payload.replyTo = activeReply.messageId;
        payload.replyPreview = {
          username: activeReply.username,
          text: activeReply.text,
          grad1: activeReply.grad1,
          grad2: activeReply.grad2,
          grad3: activeReply.grad3
        };
      }

      try {
        await addDoc(collection(db, "channels", currentChannelId, "messages"), payload);
        messageInput.value = "";
        updateCharCap();
        setActiveReply(null);
        lastMessageTime = Date.now();
        updateTimeoutUI();
        closeMentionDropdown();

        // Clear pending image after successful send
        pendingImage = null;
        if (imageFileInput) imageFileInput.value = "";
        updateImageAttachUI();
      } catch (err) {
        console.error("Error sending channel message:", err);
      }
    }

    sendBtn.addEventListener("click", () => {
      if (!sendBtn.disabled) {
        sendChannelMessage();
      }
    });

    messageInput.addEventListener("keydown", (e) => {
      if (mentionState.open) {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          if (mentionState.items.length > 0) {
            mentionState.activeIndex = (mentionState.activeIndex + 1) % mentionState.items.length;
            renderMentionDropdown();
          }
          return;
        }
        if (e.key === "ArrowUp") {
          e.preventDefault();
          if (mentionState.items.length > 0) {
            mentionState.activeIndex =
              (mentionState.activeIndex - 1 + mentionState.items.length) % mentionState.items.length;
            renderMentionDropdown();
          }
          return;
        }
        if (e.key === "Enter") {
          const item = mentionState.items[mentionState.activeIndex];
          if (item) {
            e.preventDefault();
            applyMentionSelection(item);
            return;
          }
        }
        if (e.key === "Escape") {
          closeMentionDropdown();
          return;
        }
      }

      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (!sendBtn.disabled) {
          sendChannelMessage();
        }
      }
    });

    function updateCharCap() {
      const len = messageInput.value.length;
      charCapEl.textContent = `${len} / 1000`;
      if (len > 1000) {
        charCapEl.style.color = "#fecaca";
        charCapEl.style.borderColor = "#fecaca";
      } else if (len > 900) {
        charCapEl.style.color = "#facc15";
        charCapEl.style.borderColor = "#facc15";
      } else {
        charCapEl.style.color = "";
        charCapEl.style.borderColor = "";
      }
    }

    messageInput.addEventListener("input", () => {
      updateCharCap();
      handleMentionDetection();
    });

    function stopPresence() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
      if (visibilityListenerAttached && visibilityHandler) {
        document.removeEventListener("visibilitychange", visibilityHandler);
        visibilityListenerAttached = false;
      }
    }

    function startPresence(userId) {
      const userRef = doc(db, "users", userId);

      const updatePresence = async () => {
        try {
          const result = await runTransaction(db, async (tx) => {
            const snap = await tx.get(userRef);
            const data = snap.exists() ? snap.data() : {};

            if (data.presenceOverride === true) {
              return {
                overridden: true,
                presence: data.presence || "offline"
              };
            }

            const presence = document.hidden ? "away" : "online";

            tx.set(userRef, {
              presence,
              lastActive: Date.now()
            }, { merge: true });

            return {
              overridden: false,
              presence
            };
          });

          if (!currentUserProfile) return;

          if (result.overridden) {
            currentUserProfile.presenceOverride = true;
            currentUserProfile.presence = result.presence;
            applyOwnPresence(result.presence);
          } else {
            currentUserProfile.presenceOverride = false;
            currentUserProfile.presence = result.presence;
            applyOwnPresence(result.presence);
          }
        } catch (err) {
          console.error("Error updating presence:", err);
        }
      };

      updatePresence();
      heartbeatInterval = setInterval(updatePresence, 3000);

      visibilityHandler = () => {
        updatePresence();
      };

      document.addEventListener("visibilitychange", visibilityHandler);
      visibilityListenerAttached = true;

      window.addEventListener("beforeunload", () => {
        setDoc(userRef, {
          presence: "offline",
          lastActive: Date.now()
        }, { merge: true }).catch(() => {});
      });
    }

    function openChannel(channelId) {
      currentChannelId = channelId;

      if (channelId === "uni-general") {
        channelNameEl.textContent = "universal";
        channelSubtitleEl.textContent = "Global chat for everyone in RADIANT";
      } else if (channelId === "image-links") {
        channelNameEl.textContent = "image-links";
        channelSubtitleEl.textContent = "Share image URLs, previews and references here";
      } else {
        channelNameEl.textContent = channelId;
        channelSubtitleEl.textContent = "";
      }

      messageInput.placeholder = `Message #${channelNameEl.textContent}`;

      document.querySelectorAll(".channel-item").forEach(el => {
        el.classList.toggle("active", el.dataset.channelId === channelId);
      });

      subscribeToChannelMessages(channelId);
    }

    document.querySelectorAll(".channel-item").forEach(el => {
      el.addEventListener("click", () => {
        const id = el.dataset.channelId;
        openChannel(id);
      });
    });

    function subscribeToUsers() {
      if (usersUnsub) usersUnsub();

      usersUnsub = onSnapshot(collection(db, "users"), (snapshot) => {
        userListEl.innerHTML = "";
        usersCache.clear();

        const current = auth.currentUser;

        snapshot.forEach((docSnap) => {
          const u = docSnap.data();
          const uid = docSnap.id;
          usersCache.set(uid, u);

          const effectivePresence = computeEffectivePresence(u);
          const hidden = u.hidden === true;

          if (current && uid === current.uid) {
            currentUserProfile = {
              email: u.email || current.email,
              username: u.username || current.email,
              customStatus: u.customStatus || "",
              presence: effectivePresence,
              grad1: u.grad1 || "#60a5fa",
              grad2: u.grad2 || "#a855f7",
              grad3: u.grad3 || "#f97373",
              timeoutUntil: u.timeoutUntil || null,
              hidden,
              presenceOverride: u.presenceOverride === true
            };
            renderSidebarUserName();
            userAvatarInitials.textContent = initialsFromName(currentUserProfile.username);
            applyGradientVars(currentUserProfile.grad1, currentUserProfile.grad2, currentUserProfile.grad3);
            applyOwnPresence(effectivePresence);
            updateTimeoutUI();
          }

          if (!hidden) {
            const item = document.createElement("div");
            item.className = "userlist-item";

            const avatarWrap = document.createElement("div");
            avatarWrap.className = "userlist-avatar-wrap";

            const avatar = document.createElement("div");
            avatar.className = "userlist-avatar";
            avatar.textContent = initialsFromName(u.username || u.email || "U");

            const g1 = u.grad1 || "#60a5fa";
            const g2 = u.grad2 || "#a855f7";
            avatar.style.background = `radial-gradient(circle at top, ${g1}, ${g2})`;

            const dot = document.createElement("div");
            dot.className = "userlist-status-dot";
            applyDotClass(dot, effectivePresence);

            avatarWrap.appendChild(avatar);
            avatarWrap.appendChild(dot);

            const textWrap = document.createElement("div");
            const nameEl = document.createElement("div");
            nameEl.className = "userlist-name";

            const nameText = document.createElement("span");
            nameText.textContent = u.username || u.email || "Unknown";
            nameEl.appendChild(nameText);

            if (u.email === ADMIN_EMAIL) {
              nameEl.appendChild(createAdminTag());
            }

            const statusText = document.createElement("div");
            statusText.className = "userlist-status-text";

            const label = presenceLabel(effectivePresence);
            const timeoutActive = isTimedOut(u);
            const overridden = u.presenceOverride === true;

            let statusStr = label;
            if (timeoutActive) statusStr += " ‚Ä¢ TIMED OUT";
            if (u.customStatus) statusStr += ` ‚Ä¢ ${u.customStatus}`;
            if (overridden && isAdmin) statusStr += " ‚Ä¢ overridden";

            statusText.textContent = statusStr;

            textWrap.appendChild(nameEl);
            textWrap.appendChild(statusText);

            item.appendChild(avatarWrap);
            item.appendChild(textWrap);

            userListEl.appendChild(item);
          }
        });

        if (isAdmin) {
          renderAdminUserList();
        }
      });
    }

    appearanceBtn.addEventListener("click", () => {
      appearanceModal.classList.remove("hidden");
    });

    closeAppearance.addEventListener("click", () => {
      appearanceModal.classList.add("hidden");
    });

    themeSelect.addEventListener("change", () => {
      const theme = themeSelect.value;
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
    });

    const savedTheme = localStorage.getItem("theme") || "cosy-dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    themeSelect.value = savedTheme;

    function renderAdminUserList() {
      adminUsersContainer.innerHTML = "";
      usersCache.forEach((u, uid) => {
        const effectivePresence = computeEffectivePresence(u);
        const timeoutActive = isTimedOut(u);
        const hidden = u.hidden === true;
        const overridden = u.presenceOverride === true;

        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";
        row.style.gap = "6px";
        row.style.padding = "5px 7px";
        row.style.borderRadius = "999px";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.flexDirection = "column";
        left.style.fontSize = "12px";

        const name = document.createElement("div");
        name.style.display = "inline-flex";
        name.style.alignItems = "center";
        name.style.gap = "4px";

        const nameText = document.createElement("span");
        nameText.textContent = u.username || u.email || "Unknown";
        name.appendChild(nameText);

        if (u.email === ADMIN_EMAIL) {
          name.appendChild(createAdminTag());
        }

        const meta = document.createElement("div");
        meta.style.fontSize = "11px";
        meta.style.color = "var(--text-muted)";
        const label = presenceLabel(effectivePresence);
        const timeoutLabel = timeoutActive ? " ‚Ä¢ TIMED OUT" : "";
        const hiddenLabel = hidden ? " ‚Ä¢ HIDDEN" : "";
        const overriddenLabel = overridden && isAdmin ? " ‚Ä¢ overridden" : "";
        meta.textContent = `${label}${timeoutLabel}${hiddenLabel}${overriddenLabel}`;

        left.appendChild(name);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.flexWrap = "wrap";
        right.style.gap = "4px";

        function makeBtn(text, title, handler) {
          const b = document.createElement("button");
          b.textContent = text;
          b.title = title;
          b.style.border = "1px solid var(--border-soft)";
          b.style.borderRadius = "999px";
          b.style.padding = "2px 7px";
          b.style.fontSize = "11px";
          b.style.background = "var(--bg-body)";
          b.style.color = "var(--text-main)";
          b.style.cursor = "pointer";
          b.style.transition = "background 0.12s ease, border-color 0.12s ease, transform 0.08s ease";
          b.addEventListener("mouseover", () => {
            b.style.background = "var(--bg-elevated)";
            b.style.borderColor = "var(--border-strong)";
            b.style.transform = "translateY(-1px)";
          });
          b.addEventListener("mouseout", () => {
            b.style.background = "var(--bg-body)";
            b.style.borderColor = "var(--border-soft)";
            b.style.transform = "translateY(0)";
          });
          b.addEventListener("click", handler);
          return b;
        }

        const timeout5 = makeBtn("5m", "Timeout 5 minutes", async () => {
          const until = Date.now() + 5 * 60 * 1000;
          await setDoc(doc(db, "users", uid), { timeoutUntil: until }, { merge: true });
          if (auth.currentUser && auth.currentUser.uid === uid) {
            currentUserProfile.timeoutUntil = until;
            updateTimeoutUI();
          }
        });

        const timeout60 = makeBtn("1h", "Timeout 1 hour", async () => {
          const until = Date.now() + 60 * 60 * 1000;
          await setDoc(doc(db, "users", uid), { timeoutUntil: until }, { merge: true });
          if (auth.currentUser && auth.currentUser.uid === uid) {
            currentUserProfile.timeoutUntil = until;
            updateTimeoutUI();
          }
        });

        const clearTimeoutBtn = makeBtn("Clear", "Clear timeout", async () => {
          await setDoc(doc(db, "users", uid), {
            timeoutUntil: deleteField()
          }, { merge: true });
          if (auth.currentUser && auth.currentUser.uid === uid) {
            currentUserProfile.timeoutUntil = null;
            updateTimeoutUI();
          }
        });

        const forceOnline = makeBtn("Online", "Force online", async () => {
          await setDoc(doc(db, "users", uid), {
            presence: "online",
            lastActive: Date.now(),
            presenceOverride: true
          }, { merge: true });

          if (auth.currentUser && auth.currentUser.uid === uid && currentUserProfile) {
            currentUserProfile.presenceOverride = true;
            currentUserProfile.presence = "online";
            applyOwnPresence("online");
          }
        });

        const forceAway = makeBtn("Away", "Force away", async () => {
          await setDoc(doc(db, "users", uid), {
            presence: "away",
            lastActive: Date.now(),
            presenceOverride: true
          }, { merge: true });

          if (auth.currentUser && auth.currentUser.uid === uid && currentUserProfile) {
            currentUserProfile.presenceOverride = true;
            currentUserProfile.presence = "away";
            applyOwnPresence("away");
          }
        });

        const forceOffline = makeBtn("Offline", "Force offline", async () => {
          await setDoc(doc(db, "users", uid), {
            presence: "offline",
            lastActive: Date.now(),
            presenceOverride: true
          }, { merge: true });

          if (auth.currentUser && auth.currentUser.uid === uid && currentUserProfile) {
            currentUserProfile.presenceOverride = true;
            currentUserProfile.presence = "offline";
            applyOwnPresence("offline");
          }
        });

        const clearOverrideBtn = makeBtn("Clear Override", "Remove forced presence", async () => {
          await setDoc(doc(db, "users", uid), {
            presenceOverride: false
          }, { merge: true });
        });

        const hideShowBtn = makeBtn(
          hidden ? "Show" : "Hide",
          hidden ? "Show in tablist" : "Hide from tablist",
          async () => {
            await setDoc(doc(db, "users", uid), { hidden: !hidden }, { merge: true });
          }
        );

        right.appendChild(timeout5);
        right.appendChild(timeout60);
        right.appendChild(clearTimeoutBtn);
        right.appendChild(forceOnline);
        right.appendChild(forceAway);
        right.appendChild(forceOffline);
        right.appendChild(clearOverrideBtn);
        right.appendChild(hideShowBtn);

        row.appendChild(left);
        row.appendChild(right);

        adminUsersContainer.appendChild(row);
      });
    }

    adminBtn.addEventListener("click", () => {
      if (!isAdmin) return;
      renderAdminUserList();
      adminModal.classList.remove("hidden");
    });

    adminClose.addEventListener("click", () => {
      adminModal.classList.add("hidden");
    });

    function handleMentionDetection() {
      const value = messageInput.value;
      const cursor = messageInput.selectionStart;

      const beforeCursor = value.slice(0, cursor);
      const match = /(^|\s)@([^\s@]*)$/.exec(beforeCursor);
      if (!match) {
        closeMentionDropdown();
        return;
      }

      const filter = match[2] || "";
      const triggerIndex = cursor - filter.length - 1;

      const allUsers = [];
      usersCache.forEach((u, uid) => {
        if (u.hidden === true) return;
        allUsers.push({ uid, ...u });
      });

      const filtered = allUsers
        .filter(u => {
          const uname = (u.username || "").toLowerCase();
          const email = (u.email || "").toLowerCase();
          const f = filter.toLowerCase();
          return uname.includes(f) || email.includes(f);
        })
        .sort((a, b) => (a.username || a.email || "").localeCompare(b.username || b.email || ""));

      if (filtered.length === 0) {
        closeMentionDropdown();
        return;
      }

      mentionState.open = true;
      mentionState.filter = filter;
      mentionState.items = filtered;
      mentionState.activeIndex = 0;
      mentionState.triggerIndex = triggerIndex;

      renderMentionDropdown();
    }

    function renderMentionDropdown() {
      if (!mentionState.open || mentionState.items.length === 0) {
        mentionDropdown.classList.add("hidden");
        return;
      }

      mentionDropdown.innerHTML = "";
      mentionState.items.forEach((u, index) => {
        const item = document.createElement("div");
        item.className = "mention-item";
        if (index === mentionState.activeIndex) {
          item.classList.add("active");
        }

        const avatar = document.createElement("div");
        avatar.className = "mention-avatar";
        avatar.textContent = initialsFromName(u.username || u.email || "U");
        const g1 = u.grad1 || "#60a5fa";
        const g2 = u.grad2 || "#a855f7";
        avatar.style.background = `radial-gradient(circle at top, ${g1}, ${g2})`;

        const meta = document.createElement("div");
        meta.className = "mention-meta";

        const name = document.createElement("div");
        name.className = "mention-name";
        name.textContent = u.username || u.email || "Unknown";

        const email = document.createElement("div");
        email.className = "mention-email";
        email.textContent = u.email || "";

        meta.appendChild(name);
        meta.appendChild(email);

        item.appendChild(avatar);
        item.appendChild(meta);

        item.addEventListener("mousedown", (e) => {
          e.preventDefault();
          applyMentionSelection(u);
        });

        mentionDropdown.appendChild(item);
      });

      mentionDropdown.classList.remove("hidden");
    }

    function applyMentionSelection(user) {
      const value = messageInput.value;
      const cursor = messageInput.selectionStart;

      if (mentionState.triggerIndex < 0 || mentionState.triggerIndex >= cursor) {
        closeMentionDropdown();
        return;
      }

      const before = value.slice(0, mentionState.triggerIndex);
      const after = value.slice(cursor);
      const username = user.username || user.email || "";
      const insert = `@${username} `;

      const newValue = before + insert + after;
      const newCursor = before.length + insert.length;

      messageInput.value = newValue;
      messageInput.focus();
      messageInput.setSelectionRange(newCursor, newCursor);

      updateCharCap();
      closeMentionDropdown();
    }

    function closeMentionDropdown() {
      mentionState.open = false;
      mentionState.filter = "";
      mentionState.items = [];
      mentionState.activeIndex = 0;
      mentionState.triggerIndex = -1;
      mentionDropdown.classList.add("hidden");
    }

    // --- CHANGELOG LOGIC ---
    function showChangelog() {
      changelogModal.classList.remove("hidden");

      let remaining = 5;
      changelogCloseBtn.textContent = `Close (${remaining})`;
      changelogCloseBtn.disabled = true;

      const interval = setInterval(() => {
        remaining--;
        changelogCloseBtn.textContent = `Close (${remaining})`;

        if (remaining <= 0) {
          clearInterval(interval);
          changelogCloseBtn.textContent = "Close";
          changelogCloseBtn.disabled = false;
        }
      }, 1000);
    }

    changelogCloseBtn.addEventListener("click", () => {
      changelogModal.classList.add("hidden");
    });

    function triggerChangelogAfterLogin() {
      setTimeout(showChangelog, 300);
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authView.classList.add("hidden");
        appView.classList.remove("hidden");

        try {
          const profileSnap = await getDoc(doc(db, "users", user.uid));
          const profile = profileSnap.exists() ? profileSnap.data() : null;

          const username = profile?.username || user.email;
          const customStatus = profile?.customStatus || "";
          const effectivePresence = computeEffectivePresence(profile || {});
          const grad1 = profile?.grad1 || "#60a5fa";
          const grad2 = profile?.grad2 || "#a855f7";
          const grad3 = profile?.grad3 || "#f97373";
          const timeoutUntil = profile?.timeoutUntil || null;
          const hidden = profile?.hidden === true;
          const presenceOverride = profile?.presenceOverride === true;

          currentUserProfile = {
            email: user.email,
            username,
            customStatus,
            presence: effectivePresence,
            grad1,
            grad2,
            grad3,
            timeoutUntil,
            hidden,
            presenceOverride
          };

          isAdmin = user.email === ADMIN_EMAIL;
          adminBtn.classList.toggle("hidden", !isAdmin);

          renderSidebarUserName();
          userAvatarInitials.textContent = initialsFromName(currentUserProfile.username);
          applyOwnPresence(effectivePresence);
          applyGradientVars(grad1, grad2, grad3);
          updateTimeoutUI();

          editUsernameInput.value = username;
          editStatusInput.value = customStatus;
          editGrad1Input.value = grad1;
          editGrad2Input.value = grad2;
          editGrad3Input.value = grad3;

        } catch (err) {
          console.error("Error loading profile:", err);
          const fallback = user.email;
          currentUserProfile = {
            email: user.email,
            username: fallback,
            customStatus: "",
            presence: "online",
            grad1: "#60a5fa",
            grad2: "#a855f7",
            grad3: "#f97373",
            timeoutUntil: null,
            hidden: false,
            presenceOverride: false
          };
          isAdmin = user.email === ADMIN_EMAIL;
          adminBtn.classList.toggle("hidden", !isAdmin);

          renderSidebarUserName();
          userAvatarInitials.textContent = initialsFromName(fallback);
          applyOwnPresence("online");
          applyGradientVars("#60a5fa", "#a855f7", "#f97373");
          updateTimeoutUI();
        }

        openChannel("uni-general");
        subscribeToUsers();
        startPresence(user.uid);
        updateCharCap();

        triggerChangelogAfterLogin();
      } else {
        stopPresence();
        appView.classList.add("hidden");
        authView.classList.remove("hidden");
        if (messagesUnsub) messagesUnsub();
        if (usersUnsub) usersUnsub();
        messagesEl.innerHTML = "";
        userListEl.innerHTML = "";
        loginForm.reset();
        signupForm.reset();
        loginError.textContent = "";
        signupError.textContent = "";
        lastPresenceApplied = null;
        currentChannelId = "uni-general";
        setActiveReply(null);
        isAdmin = false;
        adminBtn.classList.add("hidden");
        currentUserProfile = null;
        updateTimeoutUI();
        closeMentionDropdown();
        pendingImage = null;
        if (imageFileInput) imageFileInput.value = "";
        updateImageAttachUI();
      }
    });
  </script>
</body>
</html>
